<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="logo">üß≠</div>
        <div class="h1" id="brand">Congo WinKey</div>
        <div class="h2" id="sub">Acc√®s priv√© ‚Ä¢ Fait pour Kinshasa ‚Ä¢ CDF</div>

        <div class="badges">
          <span class="badge gold">üîí Secure</span>
          <span class="badge green">‚úÖ V√©rifi√©</span>
          <span class="badge blue">üìç Support local</span>
        </div>
      </div>

      <div class="body">
        <div class="bottom" style="margin-top:0">
          <div class="live">
            <span class="liveDot"></span>
            <span>Utilisateur: <b id="u">‚Äî</b></span>
            <a class="link" href="#" id="logout" style="margin-left:8px">D√©connexion</a>
          </div>
          <div class="timer">Acc√®s se ferme dans: <b id="timer">‚Äî</b></div>
        </div>

        <div style="height:12px"></div>

        <div class="sectionTitle">Choisissez votre jeu</div>
        <div class="games" id="games"></div>

        <div class="field">
          <label>Account ID <small id="hint">Entrez 10 chiffres</small></label>
          <input id="acc" inputmode="numeric" placeholder="Ex: 1471234567" maxlength="10" />
        </div>

        <div class="bar" aria-label="progress"><div id="bar"></div></div>
        <button class="btn" id="start">D√©marrer</button>

        <div class="alert" id="msg"></div>

        <div class="bottom">
          <div class="live">
            <span class="liveDot"></span>
            <span>En ligne (est.): <b id="online">‚Äî</b></span>
          </div>
          <div class="timer">Utilisateurs / jour: <b id="daily">‚Äî</b></div>
        </div>
      </div>

      <div class="foot">
        <span>18+ ‚Ä¢ Utilisation responsable</span>
        <span>Redirection uniquement vers le site officiel</span>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal" id="modal" aria-hidden="true">
    <div class="modalCenter">
      <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modalHead">
          <b id="modalTitle">Activation</b>
          <button class="modalClose" id="closeModal" aria-label="Fermer">‚úï</button>
        </div>

        <div class="modalBody">
          <p class="modalText" id="modalText">‚Äî</p>

          <div class="modalActions">
            <button class="btn secondary" id="official">Aller au site officiel</button>
            <button class="btn secondary" id="tg">Contacter le support (Telegram)</button>
          </div>

          <div class="modalHint" id="modalHint">‚Äî</div>

          <div class="modalSmall">
            <span>Ce site ne traite aucun paiement</span>
            <span>Support via Telegram</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script>
    const A = window.APP;
    if (sessionStorage.getItem("authed") !== "1") location.href = "./index.html";

    document.getElementById("brand").textContent = A.BRAND || "Congo WinKey";
    document.getElementById("sub").textContent = A.SUBTITLE || "";
    document.getElementById("u").textContent = sessionStorage.getItem("user") || "‚Äî";

    // Timer (auto reset if expired)
    const key = "expTs";
    function ensureExp(){
      const now = Date.now();
      const cur = Number(sessionStorage.getItem(key) || 0);
      const dur = (A.SESSION_MIN || 8) * 60 * 1000;
      if (!cur || cur < now) sessionStorage.setItem(key, String(now + dur));
    }
    ensureExp();

    const timerEl = document.getElementById("timer");
    function tick(){
      ensureExp();
      const exp = Number(sessionStorage.getItem(key) || 0);
      const left = Math.max(0, exp - Date.now());
      const mm = String(Math.floor(left/60000)).padStart(2,"0");
      const ss = String(Math.floor((left%60000)/1000)).padStart(2,"0");
      timerEl.textContent = `${mm}:${ss}`;
    }
    tick(); setInterval(tick, 500);

    // Daily users
    const min = Number(A.DAILY_MIN || 930);
    const max = Number(A.DAILY_MAX || 1100);
    document.getElementById("daily").textContent = `${min.toLocaleString("fr-FR")}‚Äì${max.toLocaleString("fr-FR")}`;

    // Online estimate (est.)
    function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
    function mulberry32(seed){
      return function(){
        seed |= 0; seed = seed + 0x6D2B79F5 | 0;
        let t = Math.imul(seed ^ seed >>> 15, 1 | seed);
        t ^= t + Math.imul(t ^ t >>> 7, 61 | t);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      };
    }
    function estimateOnline(){
      const now = new Date();
      const h = now.getHours() + now.getMinutes()/60;
      const peak1 = Math.exp(-Math.pow((h - 13.0)/3.0, 2));
      const peak2 = Math.exp(-Math.pow((h - 20.0)/3.0, 2));
      let intensity = 0.10 + 0.55*peak1 + 0.75*peak2;
      intensity = clamp(intensity, 0.10, 1.00);
      const activeShare = 0.03 + 0.07*intensity;
      const dailyMid = (min + max)/2;
      const seed = now.getFullYear()*1000000 + (now.getMonth()+1)*10000 + now.getDate()*100 + now.getHours();
      const rnd = mulberry32(seed)();
      const jitter = 0.92 + rnd*0.16;
      const est = Math.round(dailyMid * activeShare * jitter);
      return clamp(est, 20, Math.round(max*0.14));
    }
    const onlineEl = document.getElementById("online");
    function updateOnline(){ onlineEl.textContent = `~ ${estimateOnline().toLocaleString("fr-FR")}`; }
    updateOnline(); setInterval(updateOnline, 20000);

    // Build games list
    const gamesWrap = document.getElementById("games");
    let selected = "";
    (A.GAMES || []).forEach(g=>{
      const el = document.createElement("div");
      el.className = "opt";
      el.innerHTML = `<div class="optLeft"><span class="dot"></span><b>${g.key}</b></div><i>${g.icon || "‚Ä¢"}</i>`;
      el.addEventListener("click", ()=>{
        [...gamesWrap.querySelectorAll(".opt")].forEach(x=>x.classList.remove("active"));
        el.classList.add("active");
        selected = g.key;
      });
      gamesWrap.appendChild(el);
    });

    // ID validation
    const hint = document.getElementById("hint");
    if (A.REQUIRED_PREFIX) hint.textContent = `Entrez ${A.ID_LENGTH || 10} chiffres (doit commencer par ${A.REQUIRED_PREFIX})`;

    const acc = document.getElementById("acc");
    acc.addEventListener("input", ()=>{
      const L = (A.ID_LENGTH || 10);
      acc.value = acc.value.replace(/\D/g,"").slice(0, L);
    });

    const bar = document.getElementById("bar");
    const msg = document.getElementById("msg");
    const showErr = (t)=>{ msg.style.display="block"; msg.textContent=t; };

    function validate(){
      const id = acc.value.trim();
      const L = (A.ID_LENGTH || 10);
      if(!selected) return "Choisissez un jeu.";
      if(id.length !== L) return `Entrez ${L} chiffres pour l'ID.`;
      if(A.REQUIRED_PREFIX && !id.startsWith(A.REQUIRED_PREFIX)) return `L'ID doit commencer par ${A.REQUIRED_PREFIX}.`;
      return "";
    }

    // Modal
    const modal = document.getElementById("modal");
    const modalText = document.getElementById("modalText");
    const modalHint = document.getElementById("modalHint");

    function openModal(){
      modal.classList.add("isOpen");
      modal.setAttribute("aria-hidden","false");
    }
    function closeModal(){
      modal.classList.remove("isOpen");
      modal.setAttribute("aria-hidden","true");
    }
    document.getElementById("closeModal").addEventListener("click", closeModal);
    modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

    // Start
    document.getElementById("start").addEventListener("click", ()=>{
      const err = validate();
      if(err){ bar.style.width="0%"; return showErr(err); }

      msg.style.display="none";
      bar.style.width="0%";

      let p = 0;
      const t = setInterval(()=>{
        p += 18;
        bar.style.width = Math.min(100, p) + "%";
        if(p >= 100){
          clearInterval(t);
          modalText.textContent = `‚úÖ Session pr√™te pour ${selected}.`;
          modalHint.textContent =
            `1) Ouvrez le site officiel\n` +
            `2) Connectez-vous √† votre compte\n` +
            `3) Si besoin, contactez le support via Telegram.`;
          openModal();
        }
      }, 220);
    });

    // Buttons
    document.getElementById("official").addEventListener("click", ()=>{
      window.open(A.OFFICIAL_URL, "_blank", "noopener,noreferrer");
    });

    document.getElementById("tg").addEventListener("click", ()=>{
      const user = sessionStorage.getItem("user") || "";
      const id = acc.value.trim() || "‚Äî";
      const text = encodeURIComponent(
        `Bonjour.\nUser: ${user}\nID: ${id}\nJeu: ${selected}\nBesoin d‚Äôassistance.`
      );
      window.open(`https://t.me/${A.TELEGRAM_USERNAME}?text=${text}`, "_blank", "noopener,noreferrer");
    });

    document.getElementById("logout").addEventListener("click", (e)=>{
      e.preventDefault();
      sessionStorage.clear();
      location.href="./index.html";
    });
  </script>
</body>
</html>
